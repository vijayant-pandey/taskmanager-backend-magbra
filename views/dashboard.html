<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Dashboard - Task Manager</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>

<body class="container py-4">

  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Task Manager Dashboard</h2>
    <button class="btn btn-danger" onclick="logout()">Logout</button>
  </div>

  <!-- CREATE TASK FORM -->
  <div class="mb-4">
    <h4>Create Task</h4>
    <div class="mb-3">
      <label class="form-label">Token (paste or leave blank to use saved token)</label>
      <input id="token" class="form-control" placeholder="Paste token here (no 'Bearer ')">
      <div class="form-text">If you saved the token from login page, it will be used automatically.</div>
    </div>

    <form id="createTaskForm" class="row g-3">
      <div class="col-md-4">
        <input id="title" class="form-control" placeholder="Title*" required>
      </div>
      <div class="col-md-4">
        <input id="dueDate" type="date" class="form-control" placeholder="Due Date*" required>
      </div>
      <div class="col-md-4">
        <select id="priority" class="form-select">
          <option value="low">Low</option>
          <option value="medium" selected>Medium</option>
          <option value="high">High</option>
        </select>
      </div>
      <div class="col-12">
        <textarea id="description" class="form-control" placeholder="Description" rows="2"></textarea>
      </div>
      <div class="col-12">
        <input id="assignedTo" class="form-control" placeholder="Assign To (userId, optional)">
      </div>
      <div class="col-12">
        <button class="btn btn-primary" type="submit">Create Task</button>
      </div>
    </form>
    <pre id="createOutput" class="mt-2"></pre>
  </div>

  <!-- TASK LISTS -->
  <div class="row">
    <div class="col-md-4">
      <h4 class="text-info">Low Priority</h4>
      <div id="lowTasks" class="d-flex flex-column gap-3"></div>
    </div>

    <div class="col-md-4">
      <h4 class="text-warning">Medium Priority</h4>
      <div id="mediumTasks" class="d-flex flex-column gap-3"></div>
    </div>

    <div class="col-md-4">
      <h4 class="text-danger">High Priority</h4>
      <div id="highTasks" class="d-flex flex-column gap-3"></div>
    </div>
  </div>

  <script src="/js/dashboard.js"></script>

  <script>
    // AUTO FILL TOKEN
    const savedToken = localStorage.getItem('token');
    if (savedToken && !document.getElementById('token').value) {
      document.getElementById('token').value = savedToken;
    }

    // HANDLE CREATE TASK FORM
    const createForm = document.getElementById('createTaskForm');
    createForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      let token = document.getElementById('token').value.trim() || localStorage.getItem('token') || "";
      if (!token) {
        document.getElementById('createOutput').textContent = 'Please provide a token (login first).';
        return;
      }
      if (token.toLowerCase().startsWith('bearer ')) token = token.slice(7);

      const payload = {
        title: document.getElementById('title').value,
        description: document.getElementById('description').value,
        dueDate: document.getElementById('dueDate').value,
        priority: document.getElementById('priority').value,
        assignedTo: document.getElementById('assignedTo').value || undefined
      };

      try {
        const res = await fetch('/api/tasks', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
          },
          body: JSON.stringify(payload)
        });

        const data = await res.json();
        document.getElementById('createOutput').textContent = JSON.stringify(data, null, 2);

        if (res.ok) {
          createForm.reset(); // Clear form
          fetchTasks(); // Reload tasks
        }
      } catch (err) {
        document.getElementById('createOutput').textContent = 'Fetch error: ' + err.message;
      }
    });

    // LOGOUT
    function logout() {
      localStorage.removeItem('token');
      window.location.href = '/views/login.html';
    }
  </script>

</body>
</html>
