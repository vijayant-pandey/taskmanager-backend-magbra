<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Task Details</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>
<body class="container py-4">
  <a class="btn btn-link mb-3" href="/views/tasks.html">&larr; Back to Tasks</a>

  <div id="content"></div>
  <div id="msg" class="mt-3"></div>

  <script>
    // get query param "id"
    function getQueryParam(name) {
      const url = new URL(window.location.href);
      return url.searchParams.get(name);
    }

    const taskId = getQueryParam('id');
    const token = localStorage.getItem('token');

    if (!taskId) {
      document.getElementById('content').innerHTML = '<div class="alert alert-danger">No task id supplied in URL.</div>';
      throw new Error('No task id');
    }
    if (!token) {
      document.getElementById('content').innerHTML = '<div class="alert alert-warning">Please login first.</div>';
      throw new Error('No token');
    }

    async function loadTask() {
      try {
        const res = await fetch(`/api/tasks/${taskId}`, {
          headers: { 'Authorization': 'Bearer ' + token }
        });
        const task = await res.json();
        if (!res.ok) {
          document.getElementById('content').innerHTML = `<div class="alert alert-danger">${task.message || JSON.stringify(task)}</div>`;
          return;
        }

        const createdBy = task.createdBy ? `${task.createdBy.name} (${task.createdBy.email})` : task.createdBy || 'N/A';
        const assignedTo = task.assignedTo ? `${task.assignedTo.name} (${task.assignedTo.email})` : task.assignedTo || 'N/A';

        document.getElementById('content').innerHTML = `
          <div class="card shadow-sm">
            <div class="card-body">
              <h3 class="card-title">Title: ${task.title}</h3>
              <p class="card-text"><strong>Description:</strong><br/>${task.description || '-'}</p>

              <div class="row">
                <div class="col-md-4"><p class="mb-1"><strong>Due Date:</strong><br/>${task.dueDate ? new Date(task.dueDate).toLocaleString() : 'N/A'}</p></div>
                <div class="col-md-4"><p class="mb-1"><strong>Status:</strong><br/><span class="badge ${task.status === 'completed' ? 'bg-success' : 'bg-secondary'}">${task.status}</span></p></div>
                <div class="col-md-4"><p class="mb-1"><strong>Priority:</strong><br/><span class="fw-bold text-capitalize">${task.priority}</span></p></div>
              </div>

              <p class="mt-3"><strong>Created By:</strong><br/>${createdBy}</p>
              <p><strong>Assigned To:</strong><br/>${assignedTo}</p>

              <div class="mt-3 d-flex gap-2">
                <a class="btn btn-primary" href="/views/edit-task.html?id=${task._id}">Edit</a>
                <button class="btn btn-danger" onclick="deleteTask('${task._id}')">Delete</button>
                <button class="btn ${task.status === 'completed' ? 'btn-warning' : 'btn-success'}" onclick="toggleStatus('${task._id}', '${task.status}')">
                  ${task.status === 'completed' ? 'Mark Pending' : 'Mark Completed'}
                </button>
                <button class="btn btn-outline-secondary" onclick="changePriority('${task._id}')">Change Priority</button>
              </div>
            </div>
          </div>
        `;
      } catch (err) {
        document.getElementById('content').innerHTML = `<div class="alert alert-danger">Error: ${err.message}</div>`;
      }
    }

    // delete (same behavior as tasks list)
    async function deleteTask(id) {
      if (!confirm('Are you sure to delete this task?')) return;
      try {
        const res = await fetch(`/api/tasks/${id}`, {
          method: 'DELETE',
          headers: { 'Authorization': 'Bearer ' + token }
        });
        const data = await res.json();
        if (res.ok) {
          alert(data.message || 'Deleted');
          window.location.href = '/views/tasks.html';
        } else {
          document.getElementById('msg').innerHTML = `<div class="alert alert-danger">${data.message || JSON.stringify(data)}</div>`;
        }
      } catch (err) {
        document.getElementById('msg').innerHTML = `<div class="alert alert-danger">Error: ${err.message}</div>`;
      }
    }

    // toggle status (calls existing PATCH /:id/status)
    async function toggleStatus(id, currentStatus) {
      const confirmMsg = currentStatus === "completed" ? "Mark this task as Pending?" : "Mark this task as Completed?";
      if (!confirm(confirmMsg)) return;
      try {
        const newStatus = currentStatus === "completed" ? "pending" : "completed";
        const res = await fetch(`/api/tasks/${id}/status`, {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
          },
          body: JSON.stringify({ status: newStatus })
        });
        const data = await res.json();
        if (res.ok) {
          loadTask(); // refresh details
        } else {
          document.getElementById('msg').innerHTML = `<div class="alert alert-danger">${data.message || JSON.stringify(data)}</div>`;
        }
      } catch (err) {
        document.getElementById('msg').innerHTML = `<div class="alert alert-danger">Error: ${err.message}</div>`;
      }
    }

    // change priority (calls existing PATCH /:id/priority)
    async function changePriority(id) {
      try {
        const res = await fetch(`/api/tasks/${id}/priority`, {
          method: 'PATCH',
          headers: { 'Authorization': 'Bearer ' + token }
        });
        const data = await res.json();
        if (res.ok) loadTask();
        else document.getElementById('msg').innerHTML = `<div class="alert alert-danger">${data.message || JSON.stringify(data)}</div>`;
      } catch (err) {
        document.getElementById('msg').innerHTML = `<div class="alert alert-danger">Error: ${err.message}</div>`;
      }
    }

    // initialize
    loadTask();
  </script>
</body>
</html>
