<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>My Tasks</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>

<body class="container py-5">
    <h2 class="mb-4">My Tasks</h2>
    <button class="btn btn-primary mb-3" onclick="fetchTasks()">Load Tasks</button>
    
    <div class="row">
    <!-- Left: Low Priority -->
        <div class="col-md-4">
            <h4 class="text-info">Low Priority</h4>
        <div id="lowTasks" class="d-flex flex-column gap-3"></div>
        </div>

    <!-- Middle: Medium Priority -->
        <div class="col-md-4">
        <h4 class="text-warning">Medium Priority</h4>
        <div id="mediumTasks" class="d-flex flex-column gap-3"></div>
        </div>

    <!-- Right: High Priority -->
        <div class="col-md-4">
        <h4 class="text-danger">High Priority</h4>
        <div id="highTasks" class="d-flex flex-column gap-3"></div>
        </div>
    </div>

    <div class="d-flex justify-content-center mt-4">
        <nav>
            <ul id="pagination" class="pagination"></ul>
        </nav>
    </div>

<script>
// Fetch  Tasks, as Per Pagination
    let currentPage = 1;
    const limit = 6; // tasks per page

    async function fetchTasks(page = 1) {
        const token = localStorage.getItem("token");

    try {
        const res = await fetch(`/api/tasks?page=${page}&limit=${limit}`, {
        headers: { "Authorization": "Bearer " + token }
        });

    const data = await res.json();

    // Clear all columns
    document.getElementById("lowTasks").innerHTML = "";
    document.getElementById("mediumTasks").innerHTML = "";
    document.getElementById("highTasks").innerHTML = "";

    data.tasks.forEach(task => {
      let priorityClass = "";
      if (task.priority === "low") priorityClass = "bg-info";
      if (task.priority === "medium") priorityClass = "bg-warning";
      if (task.priority === "high") priorityClass = "bg-danger text-white";

      const card = document.createElement("div");
      card.className = "card " + priorityClass + " shadow-sm";

      card.innerHTML = `
        <div class="card-body">
          <h5 class="card-title">Title: ${task.title}</h5>
          
          <p class="card-text"><strong>Desc:</strong> ${task.description || ""}</p>
          
          <p class="card-text"><strong>Due Date:</strong> ${task.dueDate ? new Date(task.dueDate).toDateString() : "N/A"}</p>
          
          <p class="card-text"><strong>Status:</strong> 
            <span class="badge ${task.status === 'completed' ? 'bg-success' : 'bg-secondary'}">${task.status}</span>
          </p>
          
          <p class="card-text"><strong>Priority:</strong> ${task.priority}</p>

          <div class="mt-3 d-flex gap-2">

            <button class="btn btn-sm btn-outline-info" onclick="viewDetails('${task._id}')">View</button>

            <button class="btn btn-sm btn-outline-primary" onclick="goToEdit('${task._id}')">Edit</button>
          
            <button class="btn btn-sm btn-outline-danger" onclick="deleteTask('${task._id}')"> Delete</button>
          
            <button class="btn btn-sm ${task.status === 'completed' ? 'btn-warning' : 'btn-success'}"
                    onclick="toggleStatus('${task._id}', '${task.status}')">
              ${task.status === 'completed' ? 'Mark Pending' : 'Mark Completed'}
            </button>
          
            <button class="btn btn-sm btn-outline-secondary" onclick="changePriority('${task._id}')"> Change Priority
            </button>


          </div>
        </div>
      `;

      if (task.priority === "low") document.getElementById("lowTasks").appendChild(card);
      if (task.priority === "medium") document.getElementById("mediumTasks").appendChild(card);
      if (task.priority === "high") document.getElementById("highTasks").appendChild(card);
    });

    // Render pagination controls
    renderPagination(data.page, data.pages);

    } 
    catch (err) {
    alert("Error: " + err.message);
    }
    }

    // call edit page
    function goToEdit(taskId) {
        window.location.href = `/views/edit-task.html?id=${taskId}`;
    }

    function viewDetails(taskId) {
        window.location.href = `/views/task-details.html?id=${taskId}`;
    }

    async function deleteTask(taskId) {
    if (!confirm("Are you sure you want to delete this task?")) return;

    const token = localStorage.getItem("token");
    if (!token) return alert("No token found. Login first.");

    try {
        const res = await fetch(`/api/tasks/${taskId}`, {
        method: "DELETE",
        headers: {
            "Authorization": "Bearer " + token
        }
        });
        const data = await res.json();
        if (res.ok) {
        alert(data.message || "Task deleted");
        fetchTasks(); // refresh list
        } else {
        alert(data.message || "Delete failed");
        }
    } 
    catch (err) {
        alert("Error: " + err.message);
    }
    }

    // Toggle the status of the task 
    async function toggleStatus(taskId, currentStatus) {
        const confirmMsg = currentStatus === "completed" ? "Mark this task as Pending?" : "Mark this task as Completed?";
        if (!confirm(confirmMsg)) return;
        
        const token = localStorage.getItem("token");
        if (!token) return alert("Please login first.");

        const newStatus = currentStatus === "completed" ? "pending" : "completed";

        try {
            const res = await fetch(`/api/tasks/${taskId}/status`, {
            method: "PATCH",
            headers: {
                "Content-Type": "application/json",
                "Authorization": "Bearer " + token
            },
            body: JSON.stringify({ status: newStatus })
            });

        const data = await res.json();

            if (res.ok) {
            // refresh UI (re-load tasks)
                fetchTasks();
            } 
            else {
            alert(data.message || "Failed to update status");
            console.error("Status update response:", data);
            }
        } 
        catch (err) {
            alert("Error: " + err.message);
            console.error("toggleStatus error:", err);
        }
        }



    // Change Priority Function
    async function changePriority(taskId) {
    const token = localStorage.getItem("token");
    if (!token) return alert("Please login first.");

    try {
        const res = await fetch(`/api/tasks/${taskId}/priority`, {
        method: "PATCH",
        headers: {
            "Authorization": "Bearer " + token
        }
        });

        const data = await res.json();

        if (res.ok) {
        fetchTasks(); // reload UI
        } else {
        alert(data.message || "Failed to change priority");
        console.error("Priority update response:", data);
        }
    } catch (err) {
        alert("Error: " + err.message);
        console.error("changePriority error:", err);
    }
    }



    // Pagination LOGIC
    function renderPagination(page, pages) {
        const pagination = document.getElementById("pagination");
        pagination.innerHTML = "";

    if (pages <= 1) return; // no need for pagination

    for (let i = 1; i <= pages; i++) {
        const li = document.createElement("li");
        li.className = `page-item ${i === page ? "active" : ""}`;
        li.innerHTML = `<a class="page-link" href="#">${i}</a>`;
        li.onclick = (e) => {
        e.preventDefault();
        currentPage = i;
        fetchTasks(currentPage);
        };
        pagination.appendChild(li);
    }
    }

</script>

</body>
</html>
